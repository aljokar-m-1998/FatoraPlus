<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>مولد الفواتير — احترافي (مصحح روابط PDF)</title>

  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --primary:#0f6cff; --bg:#f4f7fb; --card:#ffffff; --text:#0b1a2b;
      --muted:#64748b; --border:#e6eef6; --radius:10px; --shadow:0 6px 24px rgba(12,20,35,0.06);
    }
    [data-theme="dark"]{
      --primary:#3b82f6; --bg:#071026; --card:#071426; --text:#e6eef8; --muted:#9fb4cd; --border:#0f2740; --shadow:none;
    }
    html,body{height:100%;margin:0;padding:0;font-family:"Cairo", Tahoma, Arial, sans-serif;background:var(--bg);color:var(--text)}
    .wrap{max-width:1100px;margin:18px auto;padding:12px}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:12px}
    h1{margin:0;font-size:18px}
    .muted{color:var(--muted);font-size:13px}
    .controls{display:flex;gap:8px;align-items:center}
    .btn{background:var(--primary);color:#fff;border:0;padding:8px 12px;border-radius:8px;cursor:pointer;box-shadow:var(--shadow)}
    .btn.ghost{background:transparent;color:var(--text);border:1px solid var(--border)}
    .btn.small{padding:6px 8px;font-size:13px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:14px;margin-bottom:12px;box-shadow:var(--shadow)}
    .grid{display:grid;gap:12px}
    .grid.cols-2{grid-template-columns:1fr 380px}
    label{display:block;font-size:13px;margin-bottom:6px;color:var(--muted)}
    input[type=text], input[type=url], input[type=number], textarea, select{width:100%;padding:8px;border-radius:8px;border:1px solid var(--border);background:transparent;color:var(--text)}
    textarea{resize:vertical}
    table{width:100%;border-collapse:collapse;font-size:14px}
    thead th{background:transparent;text-align:right;padding:10px;border-bottom:1px solid var(--border)}
    td, th{padding:8px;border-bottom:1px dashed var(--border);vertical-align:middle}
    .right{text-align:right} .center{text-align:center}
    .invoice-preview{max-width:820px;margin:0 auto;padding:20px;border-radius:10px;background:var(--card);border:1px solid var(--border)}
    .inv-head{display:flex;justify-content:space-between;align-items:flex-start;gap:12px;flex-wrap:wrap}
    .inv-left{max-width:60%}
    .logo-preview{max-height:80px;object-fit:contain}
    .items-table{width:100%;border-collapse:collapse;margin-top:12px}
    .summary{display:flex;justify-content:flex-end;margin-top:12px}
    .summary .box{width:320px}
    .qr-block{display:flex;align-items:center;gap:12px}
    .qr-box{width:110px;height:110px;display:flex;align-items:center;justify-content:center;border-radius:8px;border:1px dashed var(--border);background:transparent;cursor:pointer}
    @media (max-width:880px){ .grid.cols-2{grid-template-columns:1fr} .controls{flex-wrap:wrap} }
    @media print{ body{background:#fff} .no-print{display:none !important} @page{size:A4;margin:0} .invoice-preview{box-shadow:none;border:none;margin:0;padding:10mm;border-radius:0} }
    .saved-list {max-height:220px; overflow:auto; border:1px solid var(--border); padding:8px; border-radius:8px;}
    .saved-item{display:flex;justify-content:space-between;align-items:center;padding:6px;border-bottom:1px dashed var(--border)}
    .saved-item:last-child{border-bottom:none}
  </style>
</head>
<body data-theme="light">
  <div class="wrap">
    <header>
      <div>
        <h1>مولد الفواتير — احترافي</h1>
        <div class="muted">ملف واحد PWA — يعمل أوفلاين بعد التثبيت</div>
      </div>

      <div class="controls no-print">
        <button id="newInvoiceBtn" class="btn small">فاتورة جديدة</button>
        <select id="tplSelect" class="btn ghost small" title="قوالب"></select>
        <button id="toggleThemeBtn" class="btn ghost small">ثيم</button>
        <button id="installBtn" class="btn ghost small" style="display:none">تثبيت</button>
      </div>
    </header>

    <section class="card no-print">
      <div class="grid cols-2">
        <div>
          <label>اسم النشاط</label>
          <input id="businessName" type="text" placeholder="اسم النشاط">

          <label style="margin-top:8px">بيانات النشاط</label>
          <textarea id="businessDetails" rows="3" placeholder="العنوان، الهاتف..."></textarea>

          <label style="margin-top:8px">شعار (Logo)</label>
          <div style="display:flex;gap:8px;align-items:center">
            <input id="logoInput" type="file" accept="image/*">
            <select id="logoPos" style="width:120px">
              <option value="right">يمين</option>
              <option value="left">يسار</option>
            </select>
          </div>
          <div style="margin-top:8px">
            <img id="logoPreview" class="logo-preview" style="display:none;border-radius:8px;border:1px solid var(--border);padding:6px;background:transparent">
            <div><button id="removeLogoBtn" class="btn ghost small" style="display:none;margin-top:8px">إزالة الشعار</button></div>
          </div>
        </div>

        <div>
          <label>العميل</label>
          <div style="display:flex;gap:8px;align-items:center">
            <select id="clientsSelect" style="flex:1"></select>
            <input id="clientName" type="text" placeholder="اسم عميل جديد" style="width:200px">
            <button id="saveClientBtn" class="btn small">حفظ</button>
          </div>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="deleteClientBtn" class="btn ghost small">حذف العميل المحدد</button>
            <button id="exportClientsBtn" class="btn ghost small">تصدير عملاء</button>
          </div>

          <label style="margin-top:8px">رقم الفاتورة</label>
          <input id="invoiceNo" type="text" readonly>

          <label style="margin-top:8px">تاريخ</label>
          <input id="invoiceDate" type="text">

          <label style="margin-top:8px">العملة</label>
          <input id="currency" type="text" value="EGP">
        </div>
      </div>
    </section>

    <section class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3 style="margin:0">بنود الفاتورة</h3>
        <div style="display:flex;gap:8px;align-items:center">
          <button id="addRowBtn" class="btn small">+ إضافة بند</button>
          <button id="clearItemsBtn" class="btn ghost small">مسح البنود</button>
        </div>
      </div>

      <div style="overflow:auto;margin-top:10px">
        <table id="itemsTable">
          <thead>
            <tr>
              <th style="text-align:right">الوصف</th>
              <th style="width:90px">الكمية</th>
              <th style="width:120px">السعر</th>
              <th style="width:90px">خصم %</th>
              <th style="width:120px">الإجمالي</th>
              <th class="no-print" style="width:70px">حذف</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div style="display:flex;justify-content:flex-end;margin-top:12px">
        <div style="width:360px">
          <label>نسبة الضريبة (%)</label>
          <input id="taxPercent" type="number" value="0">
          <label style="margin-top:8px">رابط الدفع (URL)</label>
          <input id="paymentLink" type="url" placeholder="https://">
          <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
            <div id="qrSmall" class="qr-box" title="اضغط لفتح رابط الدفع"></div>
            <div style="flex:1">
              <div class="muted">اضغط على الكود لفتح الرابط أو امسحه لقراءة المعلومات</div>
              <a id="paymentAnchor" href="#" target="_blank" style="display:block;word-break:break-all;margin-top:6px;color:var(--primary)"></a>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="card no-print" style="display:flex;gap:12px;flex-wrap:wrap;align-items:flex-start">
      <div style="flex:1;min-width:260px">
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button id="previewBtn" class="btn">معاينة</button>
          <button id="printBtn" class="btn">طباعة</button>
          <button id="downloadPdfBtn" class="btn">تنزيل PDF</button>
          <button id="downloadPngBtn" class="btn">تنزيل PNG</button>
          <button id="shareBtn" class="btn ghost">مشاركة</button>
        </div>
        <div style="margin-top:10px">
          <button id="saveInvoiceBtn" class="btn">حفظ الفاتورة</button>
          <button id="exportInvoiceBtn" class="btn ghost">تصدير JSON</button>
        </div>
      </div>

      <div style="width:320px">
        <label>الفواتير المحفوظة</label>
        <div class="saved-list" id="savedInvoicesList"></div>
      </div>
    </section>

    <section id="previewArea" class="card">
      <div id="invoiceContainer"></div>
    </section>
  </div>

  <!-- مكتبات -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script>
    // Keys
    const STATE_KEY = 'inv-state-v2';
    const CLIENTS_KEY = 'inv-clients-v2';
    const INVOICES_KEY = 'inv-list-v2';
    const LAST_INV_KEY = 'inv-lastno-v2';
    const CURRENT_INV_KEY = 'inv-current-v2';
    const LOGO_KEY = 'inv-logo-v2';
    const LOGO_POS_KEY = 'inv-logo-pos-v2';
    const TEMPLATE_KEY = 'inv-tpl-v2';

    // DOM
    const businessNameEl = document.getElementById('businessName');
    const businessDetailsEl = document.getElementById('businessDetails');
    const clientsSelectEl = document.getElementById('clientsSelect');
    const clientNameEl = document.getElementById('clientName');
    const saveClientBtn = document.getElementById('saveClientBtn');
    const deleteClientBtn = document.getElementById('deleteClientBtn');
    const exportClientsBtn = document.getElementById('exportClientsBtn');
    const invoiceNoEl = document.getElementById('invoiceNo');
    const invoiceDateEl = document.getElementById('invoiceDate');
    const addRowBtn = document.getElementById('addRowBtn');
    const itemsTableBody = document.querySelector('#itemsTable tbody');
    const taxPercentEl = document.getElementById('taxPercent');
    const currencyEl = document.getElementById('currency');
    const paymentLinkEl = document.getElementById('paymentLink');
    const paymentAnchor = document.getElementById('paymentAnchor');
    const qrSmallEl = document.getElementById('qrSmall');
    const previewBtn = document.getElementById('previewBtn');
    const printBtn = document.getElementById('printBtn');
    const downloadPdfBtn = document.getElementById('downloadPdfBtn');
    const downloadPngBtn = document.getElementById('downloadPngBtn');
    const shareBtn = document.getElementById('shareBtn');
    const previewArea = document.getElementById('invoiceContainer');
    const logoInput = document.getElementById('logoInput');
    const logoPreview = document.getElementById('logoPreview');
    const removeLogoBtn = document.getElementById('removeLogoBtn');
    const logoPosEl = document.getElementById('logoPos');
    const tplSelect = document.getElementById('tplSelect');
    const newInvoiceBtn = document.getElementById('newInvoiceBtn');
    const toggleThemeBtn = document.getElementById('toggleThemeBtn');
    const installBtn = document.getElementById('installBtn');
    const clearItemsBtn = document.getElementById('clearItemsBtn');
    const saveInvoiceBtn = document.getElementById('saveInvoiceBtn');
    const savedInvoicesList = document.getElementById('savedInvoicesList');
    const exportInvoiceBtn = document.getElementById('exportInvoiceBtn');

    // state
    let state = { businessName:'', businessDetails:'', client:'', items:[], taxPercent:0, currency:'EGP', paymentLink:'', template:'classic' };
    let deferredPrompt = null;

    // ----- Helpers -----
    function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

    function getLastInvoiceNo(){ return Number(localStorage.getItem(LAST_INV_KEY) || 0); }
    function setLastInvoiceNo(n){ localStorage.setItem(LAST_INV_KEY, String(n)); }
    function formatInvoiceNo(num){ return 'INV-' + String(num).padStart(4,'0'); }
    function newInvoiceNumber(){ const last = getLastInvoiceNo()+1; setLastInvoiceNo(last); localStorage.setItem(CURRENT_INV_KEY, String(last)); return formatInvoiceNo(last); }
    function getCurrentInvoiceNo(){ const cur = Number(localStorage.getItem(CURRENT_INV_KEY) || getLastInvoiceNo()); return formatInvoiceNo(cur); }

    // ----- Storage -----
    function loadState(){ try{ const s = localStorage.getItem(STATE_KEY); if(s) state = JSON.parse(s); }catch(e){console.warn(e);} }
    function saveState(){ try{ localStorage.setItem(STATE_KEY, JSON.stringify(state)); }catch(e){console.warn(e);} }

    // ----- Clients -----
    function loadClients(){
      try{
        const list = JSON.parse(localStorage.getItem(CLIENTS_KEY) || '[]');
        clientsSelectEl.innerHTML = '<option value="">-- اختر عميل --</option>';
        list.forEach(c=>{ const o=document.createElement('option'); o.value=c; o.textContent=c; clientsSelectEl.appendChild(o); });
      }catch(e){ clientsSelectEl.innerHTML = '<option value="">-- لا يوجد --</option>'; }
    }
    function saveClient(){
      const name = clientNameEl.value.trim();
      if(!name) return alert('أدخل اسم العميل');
      let list = JSON.parse(localStorage.getItem(CLIENTS_KEY) || '[]');
      if(!list.includes(name)) list.push(name);
      localStorage.setItem(CLIENTS_KEY, JSON.stringify(list));
      clientNameEl.value='';
      loadClients();
      alert('تم حفظ العميل');
    }
    function deleteSelectedClient(){
      const sel = clientsSelectEl.value;
      if(!sel) return alert('اختر عميل للحذف');
      if(!confirm(`حذف العميل "${sel}"؟`)) return;
      let list = JSON.parse(localStorage.getItem(CLIENTS_KEY) || '[]');
      list = list.filter(x=>x!==sel);
      localStorage.setItem(CLIENTS_KEY, JSON.stringify(list));
      loadClients();
      alert('تم الحذف');
    }
    function exportClients(){
      const list = JSON.parse(localStorage.getItem(CLIENTS_KEY) || '[]');
      const blob = new Blob([JSON.stringify(list, null, 2)], {type:'application/json'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download='clients.json'; a.click();
    }

    // ----- Items -----
    function addRow(item={desc:'',qty:1,price:0,disc:0}){
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="right"><input class="item-desc" type="text" value="${escapeHtml(item.desc)}" placeholder="وصف البند"></td>
        <td><input class="item-qty" type="number" min="0" step="1" value="${item.qty}"></td>
        <td><input class="item-price" type="number" min="0" step="0.01" value="${item.price}"></td>
        <td><input class="item-disc" type="number" min="0" max="100" step="0.01" value="${item.disc}"></td>
        <td class="center item-total">0.00</td>
        <td class="center no-print"><button class="btn ghost small deleteRow">حذف</button></td>`;
      itemsTableBody.appendChild(tr);
      const inputs = tr.querySelectorAll('input');
      inputs.forEach(i=>i.addEventListener('input', ()=>{ updateRowTotal(tr); }));
      tr.querySelector('.deleteRow').addEventListener('click', ()=>{ tr.remove(); persist(); renderPreview(); });
      updateRowTotal(tr);
      persist();
      renderPreview();
    }
    function updateRowTotal(tr){
      const qty = parseFloat(tr.querySelector('.item-qty').value)||0;
      const price = parseFloat(tr.querySelector('.item-price').value)||0;
      const disc = parseFloat(tr.querySelector('.item-disc').value)||0;
      const total = (qty*price)*(1-disc/100);
      tr.querySelector('.item-total').textContent = total.toFixed(2);
    }
    function getRows(){ const rows=[]; document.querySelectorAll('#itemsTable tbody tr').forEach(tr=>{ const desc=tr.querySelector('.item-desc').value||''; const qty=+tr.querySelector('.item-qty').value||0; const price=+tr.querySelector('.item-price').value||0; const disc=+tr.querySelector('.item-disc').value||0; const total=Number(((qty*price)*(1-disc/100)).toFixed(2)); rows.push({desc,qty,price,disc,total}); }); return rows; }
    function clearItems(){ if(confirm('مسح كل البنود؟')){ itemsTableBody.innerHTML=''; addRow(); persist(); renderPreview(); } }

    // ----- Payment (QR clickable + scannable + link next to QR in preview) -----
    function updatePaymentUI(){
      const url = paymentLinkEl.value.trim();
      paymentAnchor.href = url || '#';
      paymentAnchor.textContent = url || '';
      qrSmallEl.innerHTML = '';
      qrSmallEl.onclick = null;
      if(url){
        try{
          new QRCode(qrSmallEl, { text: url, width:110, height:110 });
          qrSmallEl.style.cursor = 'pointer';
          qrSmallEl.onclick = ()=>{ window.open(url, '_blank'); };
          setTimeout(()=>{ const inner = qrSmallEl.querySelector('img,canvas,table'); if(inner) inner.style.pointerEvents = 'none'; }, 50);
        }catch(e){ console.warn(e); }
      } else {
        qrSmallEl.style.cursor = 'default';
      }
    }

    // ----- Build invoice HTML (preview/print) -----
    function buildInvoiceHTML(dataState){
      const rows = dataState.items || [];
      let subtotal = 0; rows.forEach(r=> subtotal += r.total);
      const tax = +(subtotal * (Number(dataState.taxPercent||0)/100));
      const total = +(subtotal + tax);
      const invNo = dataState.invoiceNo || getCurrentInvoiceNo();
      const date = dataState.invoiceDate || new Date().toLocaleDateString('ar-EG');
      const logoData = localStorage.getItem(LOGO_KEY);
      const logoPos = localStorage.getItem(LOGO_POS_KEY) || 'right';
      const tpl = dataState.template || localStorage.getItem(TEMPLATE_KEY) || 'classic';

      const itemsHtml = rows.map(r=>`<tr>
        <td style="text-align:right;padding:8px">${escapeHtml(r.desc)}</td>
        <td style="text-align:center;padding:8px">${r.qty}</td>
        <td style="text-align:center;padding:8px">${r.price} ${escapeHtml(dataState.currency||'EGP')}</td>
        <td style="text-align:center;padding:8px">${r.disc}%</td>
        <td style="text-align:center;padding:8px">${r.total} ${escapeHtml(dataState.currency||'EGP')}</td>
      </tr>`).join('');

      const logoHtml = logoData ? `<img src="${logoData}" style="max-height:70px;${logoPos==='left'?'margin-left:12px':'margin-right:12px'}">` : '';

      return `
        <div class="invoice-preview ${tpl}" id="invoicePrintable" style="position:relative;">
          <div class="inv-head">
            <div class="inv-left">
              ${logoPos==='left'?logoHtml:''}
              <div><h2 style="margin:0">${escapeHtml(dataState.businessName||'اسم النشاط')}</h2></div>
              <div class="muted">${escapeHtml(dataState.businessDetails||'')}</div>
            </div>
            <div style="text-align:left">
              ${logoPos==='right'?logoHtml:''}
              <div class="muted"><strong>فاتورة:</strong> ${escapeHtml(invNo)}</div>
              <div class="muted"><strong>تاريخ:</strong> ${escapeHtml(date)}</div>
              <div class="muted"><strong>العملة:</strong> ${escapeHtml(dataState.currency||'EGP')}</div>
            </div>
          </div>

          <hr style="border:none;border-top:1px solid var(--border);margin:12px 0">

          <div>
            <table class="items-table" style="width:100%;border-collapse:collapse">
              <thead><tr><th style="text-align:right">الوصف</th><th style="text-align:center">الكمية</th><th style="text-align:center">السعر</th><th style="text-align:center">خصم</th><th style="text-align:center">الإجمالي</th></tr></thead>
              <tbody>${itemsHtml}</tbody>
            </table>
          </div>

          <div class="summary" style="margin-top:14px">
            <div class="box">
              <div style="display:flex;justify-content:space-between"><span>المجموع الفرعي</span><span>${subtotal.toFixed(2)} ${escapeHtml(dataState.currency||'EGP')}</span></div>
              <div style="display:flex;justify-content:space-between"><span>الضريبة (${escapeHtml(dataState.taxPercent||0)}%)</span><span>${tax.toFixed(2)} ${escapeHtml(dataState.currency||'EGP')}</span></div>
              <hr>
              <div style="display:flex;justify-content:space-between;font-weight:700"><span>الإجمالي</span><span>${total.toFixed(2)} ${escapeHtml(dataState.currency||'EGP')}</span></div>
            </div>
          </div>

          <div style="display:flex;justify-content:space-between;align-items:center;margin-top:14px">
            <div class="muted">شكرًا لتعاملكم</div>
            <div style="display:flex;align-items:center;gap:12px">
              <div style="display:flex;align-items:center;gap:12px">
                <a id="qrPrintableAnchor" href="${escapeHtml(dataState.paymentLink||'#')}" target="_blank" style="text-decoration:none;">
                  <div id="qrForPrintable" class="qr-box" title="اضغط لفتح رابط الدفع"></div>
                </a>
                <div style="min-width:160px;max-width:240px;word-break:break-all;font-size:13px">
                  <div class="muted">رابط الدفع</div>
                  <a id="payLinkText" href="${escapeHtml(dataState.paymentLink||'#')}" target="_blank" style="color:var(--primary)">${escapeHtml(dataState.paymentLink||'-')}</a>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    // ----- Render preview -----
    function renderPreview(){
      persist(); // update state from UI
      const previewState = Object.assign({}, state, {
        items: getRows(),
        invoiceNo: invoiceNoEl.value || getCurrentInvoiceNo(),
        invoiceDate: invoiceDateEl.value || new Date().toLocaleDateString('ar-EG')
      });
      previewArea.innerHTML = buildInvoiceHTML(previewState);
      // build QR for printable and make clickable
      const qrContainer = document.getElementById('qrForPrintable');
      const payText = document.getElementById('payLinkText');
      if(payText) payText.href = previewState.paymentLink || '#';
      if(qrContainer){
        qrContainer.innerHTML = '';
        if(previewState.paymentLink){
          try{
            new QRCode(qrContainer, { text: previewState.paymentLink, width:110, height:110 });
            qrContainer.style.cursor = 'pointer';
            qrContainer.onclick = ()=>{ window.open(previewState.paymentLink, '_blank'); };
            setTimeout(()=>{ const inner = qrContainer.querySelector('img,canvas,table'); if(inner) inner.style.pointerEvents='none'; }, 50);
          }catch(e){ console.warn(e); }
        }
      }
    }

    // ----- Persist UI -> state -----
    function persist(){
      state.businessName = businessNameEl.value;
      state.businessDetails = businessDetailsEl.value;
      state.client = clientsSelectEl.value || clientNameEl.value;
      state.items = getRows();
      state.taxPercent = Number(taxPercentEl.value) || 0;
      state.currency = currencyEl.value || 'EGP';
      state.paymentLink = paymentLinkEl.value || '';
      state.template = tplSelect.value || 'classic';
      saveState();
      updatePaymentUI();
    }

    // ----- Save / Load invoices -----
    function readInvoices(){ try{ return JSON.parse(localStorage.getItem(INVOICES_KEY) || '[]'); }catch(e){return[];} }
    function writeInvoices(list){ localStorage.setItem(INVOICES_KEY, JSON.stringify(list)); }

    function saveInvoice(){
      persist();
      const invoices = readInvoices();
      // ensure invoice number - if empty create new
      if(!invoiceNoEl.value || invoiceNoEl.value.trim() === '') invoiceNoEl.value = newInvoiceNumber();
      const inv = {
        id: Date.now(),
        invoiceNo: invoiceNoEl.value,
        invoiceDate: invoiceDateEl.value || new Date().toLocaleDateString('ar-EG'),
        businessName: state.businessName,
        businessDetails: state.businessDetails,
        client: state.client,
        items: state.items,
        taxPercent: state.taxPercent,
        currency: state.currency,
        paymentLink: state.paymentLink,
        logo: localStorage.getItem(LOGO_KEY) || null,
        template: state.template
      };
      // if invoice with same invoiceNo exists, replace it (allow updating)
      const existingIndex = invoices.findIndex(x => x.invoiceNo === inv.invoiceNo);
      if(existingIndex >= 0) invoices[existingIndex] = inv;
      else invoices.unshift(inv);
      writeInvoices(invoices);
      renderInvoicesList();
      alert('تم حفظ الفاتورة');
    }

    function renderInvoicesList(){
      const invoices = readInvoices();
      savedInvoicesList.innerHTML = '';
      if(invoices.length===0){ savedInvoicesList.innerHTML = '<div class="muted">لا توجد فواتير محفوظة</div>'; return; }
      invoices.forEach(inv=>{
        const div = document.createElement('div'); div.className='saved-item';
        const left = document.createElement('div'); left.innerHTML = `<strong>${escapeHtml(inv.invoiceNo)}</strong><div class="muted" style="font-size:12px">${escapeHtml(inv.businessName||'')}</div>`;
        const right = document.createElement('div');
        const loadBtn = document.createElement('button'); loadBtn.className='btn small'; loadBtn.textContent='تحميل'; loadBtn.onclick = ()=>loadInvoice(inv.id);
        const delBtn = document.createElement('button'); delBtn.className='btn ghost small'; delBtn.textContent='حذف'; delBtn.onclick = ()=>{ if(confirm('حذف الفاتورة؟')){ deleteInvoice(inv.id); } };
        right.appendChild(loadBtn); right.appendChild(delBtn);
        div.appendChild(left); div.appendChild(right);
        savedInvoicesList.appendChild(div);
      });
    }

    function loadInvoice(id){
      const invoices = readInvoices();
      const inv = invoices.find(x=>x.id===id);
      if(!inv) return alert('الفاتورة غير موجودة');
      businessNameEl.value = inv.businessName || '';
      businessDetailsEl.value = inv.businessDetails || '';
      clientNameEl.value = inv.client || '';
      itemsTableBody.innerHTML = '';
      if(inv.items && inv.items.length) inv.items.forEach(it=>addRow(it)); else addRow();
      taxPercentEl.value = inv.taxPercent || 0;
      currencyEl.value = inv.currency || 'EGP';
      paymentLinkEl.value = inv.paymentLink || '';
      invoiceNoEl.value = inv.invoiceNo || getCurrentInvoiceNo();
      invoiceDateEl.value = inv.invoiceDate || new Date().toLocaleDateString('ar-EG');
      if(inv.logo){ localStorage.setItem(LOGO_KEY, inv.logo); logoPreview.src = inv.logo; logoPreview.style.display='inline-block'; removeLogoBtn.style.display='inline-block'; }
      state.template = inv.template || 'classic'; tplSelect.value = state.template;
      persist(); renderPreview();
      alert('تم تحميل الفاتورة');
    }

    function deleteInvoice(id){
      let invoices = readInvoices();
      invoices = invoices.filter(x=>x.id!==id);
      writeInvoices(invoices);
      renderInvoicesList();
    }

    function exportCurrentInvoice(){
      persist();
      const inv = {
        invoiceNo: invoiceNoEl.value || getCurrentInvoiceNo(),
        invoiceDate: invoiceDateEl.value || new Date().toLocaleDateString('ar-EG'),
        businessName: businessNameEl.value,
        businessDetails: businessDetailsEl.value,
        client: clientsSelectEl.value || clientNameEl.value,
        items: getRows(),
        taxPercent: Number(taxPercentEl.value)||0,
        currency: currencyEl.value||'EGP',
        paymentLink: paymentLinkEl.value||'',
        logo: localStorage.getItem(LOGO_KEY) || null
      };
      const blob = new Blob([JSON.stringify(inv, null, 2)], {type:'application/json'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = (inv.invoiceNo || 'invoice') + '.json'; a.click();
    }

    // ----- Download / Share with PDF link annotation (FIXED coordinates) -----
    async function downloadPDF(){
      try{
        renderPreview();
        const target = document.getElementById('invoicePrintable');
        if(!target){ alert('اضغط معاينة أولاً'); return; }

        // Render full canvas of the invoice element
        const canvas = await html2canvas(target, {scale:2, useCORS:true, allowTaint:true});
        const imgData = canvas.toDataURL('image/png');
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF('p','mm','a4');

        const pageWidthMM = pdf.internal.pageSize.getWidth();
        const pageHeightMM = pdf.internal.pageSize.getHeight();

        // conversion factors
        const canvasWidthPx = canvas.width;
        const canvasHeightPx = canvas.height;
        const mmPerPx = pageWidthMM / canvasWidthPx;

        // page chunk in canvas pixels
        const pxPageHeight = Math.floor((canvasWidthPx * pageHeightMM) / pageWidthMM);

        // function to add a canvas slice to PDF page
        const addCanvasSliceToPdf = (sx, sy, sWidth, sHeight, destYMM, isFirstPage) => {
          // create temporary canvas for this slice
          const tmpCanvas = document.createElement('canvas');
          tmpCanvas.width = sWidth;
          tmpCanvas.height = sHeight;
          const ctx = tmpCanvas.getContext('2d');
          ctx.drawImage(canvas, sx, sy, sWidth, sHeight, 0, 0, sWidth, sHeight);
          const data = tmpCanvas.toDataURL('image/png');
          const destHeightMM = sHeight * mmPerPx;
          pdf.addImage(data, 'PNG', 0, destYMM, pageWidthMM, destHeightMM);
        };

        // compute QR rectangle on the canvas (in canvas pixels)
        const qrEl = target.querySelector('#qrForPrintable');
        let qrCanvasRect = null;
        if(qrEl){
          const targetRect = target.getBoundingClientRect();
          const qrRect = qrEl.getBoundingClientRect();
          const relX = qrRect.left - targetRect.left;
          const relY = qrRect.top - targetRect.top;
          const relW = qrRect.width;
          const relH = qrRect.height;
          const scale = canvas.width / target.offsetWidth; // canvas px per DOM px
          const xCanvas = relX * scale;
          const yCanvas = relY * scale;
          const wCanvas = relW * scale;
          const hCanvas = relH * scale;
          qrCanvasRect = { x: xCanvas, y: yCanvas, w: wCanvas, h: hCanvas };
        }

        // iterate pages and add slices
        let position = 0;
        let pageIndex = 0;
        while(position < canvasHeightPx){
          const sliceHeight = Math.min(pxPageHeight, canvasHeightPx - position);
          const destYMM = 0; // we place each slice at top of PDF page
          if(pageIndex > 0) pdf.addPage();
          addCanvasSliceToPdf(0, position, canvasWidthPx, sliceHeight, destYMM, pageIndex === 0);

          // if QR exists, check overlap with this slice and add link annotation
          if(qrCanvasRect){
            const qrTop = qrCanvasRect.y;
            const qrBottom = qrCanvasRect.y + qrCanvasRect.h;
            const sliceTop = position;
            const sliceBottom = position + sliceHeight;
            const overlapTop = Math.max(qrTop, sliceTop);
            const overlapBottom = Math.min(qrBottom, sliceBottom);
            if(overlapBottom > overlapTop){
              // there is overlap on this page
              const yOnSlicePx = overlapTop - sliceTop;
              const hOnSlicePx = overlapBottom - overlapTop;
              const xOnSlicePx = qrCanvasRect.x;
              const wOnSlicePx = qrCanvasRect.w;

              // convert to mm
              const xMM = xOnSlicePx * mmPerPx;
              const yMM = yOnSlicePx * mmPerPx;
              const wMM = wOnSlicePx * mmPerPx;
              const hMM = hOnSlicePx * mmPerPx;

              // ensure coordinates are within page bounds
              const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));
              const xClamped = clamp(xMM, 0, pageWidthMM - 1);
              const yClamped = clamp(yMM, 0, pageHeightMM - 1);
              const wClamped = clamp(wMM, 1, pageWidthMM - xClamped);
              const hClamped = clamp(hMM, 1, pageHeightMM - yClamped);

              // add link annotation on current page
              const url = paymentLinkEl.value.trim();
              if(url){
                try{
                  pdf.link(xClamped, yClamped, wClamped, hClamped, { url });
                }catch(err){
                  // fallback: add text link near QR area (lower-left of QR)
                  try{
                    const textX = xClamped;
                    const textY = Math.min(pageHeightMM - 10, yClamped + hClamped + 4);
                    pdf.setTextColor(0,0,255);
                    pdf.textWithLink('فتح رابط الدفع', textX, textY, { url });
                    pdf.setTextColor(0,0,0);
                  }catch(e){}
                }
              }
            }
          }

          position += sliceHeight;
          pageIndex++;
        }

        const invNo = invoiceNoEl.value || getCurrentInvoiceNo();
        pdf.save(`${invNo}.pdf`);
      }catch(e){ console.error(e); alert('فشل إنشاء PDF: ' + (e && e.message ? e.message : 'خطأ غير متوقع')); }
    }

    // ----- Image download -----
    async function downloadAsImage(){
      try{
        renderPreview();
        const target = document.getElementById('invoicePrintable');
        if(!target){ alert('اضغط معاينة أولاً'); return; }
        const canvas = await html2canvas(target, {scale:2, useCORS:true, allowTaint:true});
        const link = document.createElement('a'); link.download = (invoiceNoEl.value || getCurrentInvoiceNo()) + '.png'; link.href = canvas.toDataURL('image/png'); link.click();
      }catch(e){ console.error(e); alert('فشل تنزيل الصورة'); }
    }

    async function shareInvoice(){
      try{
        persist();
        const rows = getRows(); let subtotal = 0; rows.forEach(r=>subtotal += r.total);
        const tax = +(subtotal * (Number(taxPercentEl.value||0)/100)); const total = +(subtotal + tax);
        const text = `فاتورة ${invoiceNoEl.value || getCurrentInvoiceNo()}\nالإجمالي: ${total.toFixed(2)} ${currencyEl.value||'EGP'}\n${paymentLinkEl.value||''}`;
        if(navigator.share){ await navigator.share({title:'فاتورة', text, url: paymentLinkEl.value||undefined}); }
        else if(navigator.clipboard){ await navigator.clipboard.writeText(text); alert('تم نسخ ملخص الفاتورة'); }
        else alert('المشاركة غير مدعومة');
      }catch(e){ console.warn(e); alert('فشل المشاركة'); }
    }

    // ----- Logo handling -----
    logoInput.addEventListener('change', (e)=>{
      const f = e.target.files[0];
      if(!f) return;
      const reader = new FileReader();
      reader.onload = ()=>{ localStorage.setItem(LOGO_KEY, reader.result); localStorage.setItem(LOGO_POS_KEY, logoPosEl.value||'right'); logoPreview.src = reader.result; logoPreview.style.display='inline-block'; removeLogoBtn.style.display='inline-block'; persist(); renderPreview(); };
      reader.readAsDataURL(f);
    });
    removeLogoBtn.addEventListener('click', ()=>{ localStorage.removeItem(LOGO_KEY); localStorage.removeItem(LOGO_POS_KEY); logoPreview.src=''; logoPreview.style.display='none'; removeLogoBtn.style.display='none'; persist(); renderPreview(); });
    function loadLogoPreview(){ const d = localStorage.getItem(LOGO_KEY); if(d){ logoPreview.src = d; logoPreview.style.display='inline-block'; removeLogoBtn.style.display='inline-block'; logoPosEl.value = localStorage.getItem(LOGO_POS_KEY) || 'right'; } }

    // ----- Persist / state save -----
    function persist(){ state.businessName = businessNameEl.value; state.businessDetails = businessDetailsEl.value; state.client = clientsSelectEl.value || clientNameEl.value; state.items = getRows(); state.taxPercent = Number(taxPercentEl.value) || 0; state.currency = currencyEl.value || 'EGP'; state.paymentLink = paymentLinkEl.value || ''; state.template = tplSelect.value || 'classic'; saveState(); updatePaymentUI(); }

    function saveState(){ try{ localStorage.setItem(STATE_KEY, JSON.stringify(state)); }catch(e){console.warn(e);} }

    // ----- Save/load invoices list rendering -----
    function initInvoicesList(){ renderInvoicesList(); }
    function renderInvoicesList(){ const invoices = readInvoices(); savedInvoicesList.innerHTML=''; if(invoices.length===0){ savedInvoicesList.innerHTML = '<div class="muted">لا توجد فواتير محفوظة</div>'; return; } invoices.forEach(inv=>{ const div=document.createElement('div'); div.className='saved-item'; const left=document.createElement('div'); left.innerHTML=`<strong>${escapeHtml(inv.invoiceNo)}</strong><div class="muted" style="font-size:12px">${escapeHtml(inv.businessName||'')}</div>`; const right=document.createElement('div'); const loadBtn=document.createElement('button'); loadBtn.className='btn small'; loadBtn.textContent='تحميل'; loadBtn.onclick=()=>loadInvoice(inv.id); const delBtn=document.createElement('button'); delBtn.className='btn ghost small'; delBtn.textContent='حذف'; delBtn.onclick=()=>{ if(confirm('حذف الفاتورة؟')) deleteInvoice(inv.id); }; right.appendChild(loadBtn); right.appendChild(delBtn); div.appendChild(left); div.appendChild(right); savedInvoicesList.appendChild(div); }); }

    function readInvoices(){ try{ return JSON.parse(localStorage.getItem(INVOICES_KEY) || '[]'); }catch(e){return[];} }
    function writeInvoices(list){ localStorage.setItem(INVOICES_KEY, JSON.stringify(list)); }

    function loadInvoice(id){
      const invoices = readInvoices();
      const inv = invoices.find(x=>x.id===id);
      if(!inv) return alert('الفاتورة غير موجودة');
      businessNameEl.value = inv.businessName || '';
      businessDetailsEl.value = inv.businessDetails || '';
      clientNameEl.value = inv.client || '';
      itemsTableBody.innerHTML = '';
      if(inv.items && inv.items.length) inv.items.forEach(it=>addRow(it)); else addRow();
      taxPercentEl.value = inv.taxPercent || 0;
      currencyEl.value = inv.currency || 'EGP';
      paymentLinkEl.value = inv.paymentLink || '';
      invoiceNoEl.value = inv.invoiceNo || getCurrentInvoiceNo();
      invoiceDateEl.value = inv.invoiceDate || new Date().toLocaleDateString('ar-EG');
      if(inv.logo){ localStorage.setItem(LOGO_KEY, inv.logo); logoPreview.src = inv.logo; logoPreview.style.display='inline-block'; removeLogoBtn.style.display='inline-block'; }
      state.template = inv.template || 'classic'; tplSelect.value = state.template;
      persist(); renderPreview();
      alert('تم تحميل الفاتورة');
    }

    function deleteInvoice(id){ let invoices=readInvoices(); invoices=invoices.filter(x=>x.id!==id); writeInvoices(invoices); renderInvoicesList(); }

    // ----- Manifest & SW registration (inline) -----
    (function registerManifestAndSW(){
      try{
        const manifest = {
          name: "مولد الفواتير",
          short_name: "فواتيري",
          start_url: ".",
          display: "standalone",
          background_color: "#ffffff",
          theme_color: "#0f6cff",
          icons: [
            { src: "data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='192' height='192'><rect width='100%' height='100%' fill='%230f6cff'/><text x='50%' y='55%' font-size='72' text-anchor='middle' fill='white'>ف</text></svg>", sizes:"192x192", type:"image/svg+xml" },
            { src: "data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='512' height='512'><rect width='100%' height='100%' fill='%230f6cff'/><text x='50%' y='55%' font-size='240' text-anchor='middle' fill='white'>ف</text></svg>", sizes:"512x512", type:"image/svg+xml" }
          ]
        };
        const mfBlob = new Blob([JSON.stringify(manifest)], {type:'application/json'});
        const mfUrl = URL.createObjectURL(mfBlob);
        const link = document.querySelector('link[rel="manifest"]') || document.createElement('link');
        link.rel = 'manifest'; link.href = mfUrl; if(!document.querySelector('link[rel="manifest"]')) document.head.appendChild(link);
      }catch(e){ console.warn(e); }

      const swSource = `
        const CACHE_NAME = 'invoice-pwa-cache-v2';
        const ASSETS = ['./'];
        self.addEventListener('install', e => { self.skipWaiting(); e.waitUntil(caches.open(CACHE_NAME).then(c => c.addAll(ASSETS).catch(()=>{}))); });
        self.addEventListener('activate', e => { e.waitUntil(caches.keys().then(keys => Promise.all(keys.filter(k=>k!==CACHE_NAME).map(k=>caches.delete(k))))); self.clients.claim(); });
        self.addEventListener('fetch', e => { e.respondWith(caches.match(e.request).then(cached=>cached||fetch(e.request).then(resp=>{ if(e.request.method==='GET'){ caches.open(CACHE_NAME).then(cache=>{ try{ cache.put(e.request, resp.clone()); }catch(e){} }); } return resp.clone(); }).catch(()=>caches.match('/')))); });
      `;
      if('serviceWorker' in navigator){
        try{
          const blob = new Blob([swSource], {type:'application/javascript'});
          const swUrl = URL.createObjectURL(blob);
          navigator.serviceWorker.register(swUrl).then(()=>console.log('SW registered')).catch(err=>console.warn('SW failed',err));
        }catch(e){ console.warn('SW create fail', e); }
      }
    })();

    // ----- Init -----
    function init(){
      tplSelect.innerHTML = '<option value="classic">كلاسيك</option><option value="modern">مودرن</option><option value="compact">مضغوط</option>';
      try{ const s = JSON.parse(localStorage.getItem(STATE_KEY) || '{}'); if(s) state = Object.assign(state, s); }catch(e){}
      businessNameEl.value = state.businessName || '';
      businessDetailsEl.value = state.businessDetails || '';
      taxPercentEl.value = state.taxPercent || 0;
      currencyEl.value = state.currency || 'EGP';
      paymentLinkEl.value = state.paymentLink || '';
      tplSelect.value = state.template || 'classic';
      invoiceDateEl.value = new Date().toLocaleDateString('ar-EG');
      // ensure there is a current invoice number (generate if none)
      if(!localStorage.getItem(CURRENT_INV_KEY) || Number(localStorage.getItem(CURRENT_INV_KEY))===0){ invoiceNoEl.value = newInvoiceNumber(); } else invoiceNoEl.value = getCurrentInvoiceNo();

      loadClients();
      renderInvoicesList();

      itemsTableBody.innerHTML = '';
      if(state.items && state.items.length) state.items.forEach(it=>addRow(it)); else addRow();

      loadLogoPreview();
      updatePaymentUI();
      renderPreview();

      // events
      addRowBtn.addEventListener('click', ()=>addRow());
      clearItemsBtn.addEventListener('click', clearItems);
      saveClientBtn.addEventListener('click', saveClient);
      deleteClientBtn.addEventListener('click', deleteSelectedClient);
      exportClientsBtn.addEventListener('click', exportClients);
      paymentLinkEl.addEventListener('input', updatePaymentUI);
      previewBtn.addEventListener('click', ()=>{ renderPreview(); window.scrollTo({top:0,behavior:'smooth'}); });
      printBtn.addEventListener('click', ()=>{ renderPreview(); window.print(); });
      downloadPdfBtn.addEventListener('click', downloadPDF);
      downloadPngBtn.addEventListener('click', downloadAsImage);
      shareBtn.addEventListener('click', shareInvoice);
      saveInvoiceBtn.addEventListener('click', saveInvoice);
      exportInvoiceBtn.addEventListener('click', exportCurrentInvoice);
      tplSelect.addEventListener('change', ()=>{ state.template = tplSelect.value; localStorage.setItem(TEMPLATE_KEY, state.template); renderPreview(); });
      newInvoiceBtn.addEventListener('click', ()=>{
        invoiceNoEl.value = newInvoiceNumber();
        invoiceDateEl.value = new Date().toLocaleDateString('ar-EG');
        itemsTableBody.innerHTML=''; addRow(); persist(); renderPreview();
      });
      toggleThemeBtn.addEventListener('click', ()=>{
        const cur = document.documentElement.getAttribute('data-theme') || 'light';
        const next = cur==='dark'?'light':'dark';
        document.documentElement.setAttribute('data-theme', next);
        document.body.setAttribute('data-theme', next);
        localStorage.setItem('theme', next);
      });

      window.addEventListener('beforeinstallprompt', (e)=>{ e.preventDefault(); deferredPrompt = e; installBtn.style.display='inline-block'; });
      installBtn.addEventListener('click', async ()=>{ if(!deferredPrompt) return; deferredPrompt.prompt(); await deferredPrompt.userChoice; deferredPrompt=null; installBtn.style.display='none'; });

      qrSmallEl.addEventListener('click', ()=>{ const url = paymentLinkEl.value.trim(); if(url) window.open(url,'_blank'); });
    }

    window.addEventListener('load', init);
  </script>
</body>
</html>
